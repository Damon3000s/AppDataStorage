<!-- Generated by SpecStory -->

# Testing threadsafe mock filesystem usage (2025-06-08 22:12:06)

_**User**_

do the tests use the threadsafe mock filesystem api such that each test gets its own ifilesystem mock instance?

---

_**Assistant**_



---

I'll examine the test project to understand how the filesystem mocking is implemented and whether each test gets its own IFileSystem mock instance.

---

<details>
            <summary>Listed directory AppDataStorage.Test ‚Ä¢ **5** results</summary>
        
| Name |
|-------|
| üìÑ `AppDataTests.cs` |
| üìÑ `StrongStringTests.cs` |
| üìÅ `obj` |
| üìÑ `AppDataStorage.Test.csproj` |
| üìÅ `bin` |

</details>

---

Let me examine the main test files to see how filesystem mocking is implemented:

---

Read file: AppDataStorage.Test/AppDataTests.cs

---

Now let me check the project file to see what testing framework and mocking libraries are being used:

---

Read file: AppDataStorage.Test/AppDataStorage.Test.csproj

---

Let me also check how the main AppData class is structured to understand the filesystem abstraction:

---

<details>
            <summary>Searched codebase "AppData ConfigureForTesting MockFileSystem IFileSystem" ‚Ä¢ **25** results</summary>
        
| File | Lines |
|------|-------|
| `AppDataStorage/AppData.cs` | L215-250 |
| `AppDataStorage/AppData.cs` | L250-285 |
| `AppDataStorage.Test/AppDataTests.cs` | L410-456 |
| `AppDataStorage.Test/AppDataTests.cs` | L1-68 |
| `AppDataStorage.Test/AppDataTests.cs` | L283-341 |
| `AppDataStorage/AppData.cs` | L285-338 |
| `AppDataStorage.Test/StrongStringTests.cs` | L1-68 |
| `AppDataStorage.Test/AppDataTests.cs` | L68-119 |
| `AppDataStorage/AppData.cs` | L1-55 |
| `AppDataStorage.Test/AppDataTests.cs` | L170-234 |
| `AppDataStorage.Test/AppDataTests.cs` | L504-557 |
| `AppDataStorage/AppData.cs` | L55-112 |
| `AppDataStorage.Test/AppDataTests.cs` | L119-170 |
| `AppDataStorage.Test/AppDataTests.cs` | L234-283 |
| `AppDataStorage.Test/AppDataTests.cs` | L557-580 |
| `AppDataStorage.Test/AppDataTests.cs` | L456-504 |
| `AppDataStorage.Test/AppDataTests.cs` | L341-410 |
| `AppDataStorage/AppData.cs` | L112-157 |
| `AppDataStorage/AppData.cs` | L463-511 |
| `AppDataStorage.Test/StrongStringTests.cs` | L68-110 |
| `AppDataStorage/AppData.cs` | L157-215 |
| `AppDataStorage.Test/AppDataStorage.Test.csproj` | L1-8 |
| `AppDataStorage/AppData.cs` | L409-463 |
| `AppDataStorage/AppData.cs` | L338-409 |
| `.cursor/rules/derived-cursor-rules.mdc` | L37-65 |

</details>

---

Based on my analysis of the test code and the main AppData implementation, I can answer your question about thread safety and mock filesystem isolation:

**No, the current tests do NOT use a threadsafe mock filesystem API where each test gets its own IFileSystem mock instance.**

Here's what's happening:

## Current Test Setup

Looking at the test setup in `AppDataTests.cs` (lines 18-21):

```18:21:AppDataStorage.Test/AppDataTests.cs
[TestInitialize]
public void Setup()
{
	AppData.ConfigureForTesting(new MockFileSystem());
	AppDomain.CurrentDomain.SetData("APP_CONTEXT_BASE_DIRECTORY", "/app");
}
```

The tests are using `AppData.ConfigureForTesting(new MockFileSystem())` which creates a **single shared MockFileSystem instance** for all tests in that test class. This approach has a significant limitation.

## The Problem

From the AppData.cs implementation, I can see that while there is infrastructure for thread-safe testing using `ThreadLocal<Func<IFileSystem>?>`, the current test setup is using the **shared instance overload** of `ConfigureForTesting`:

```csharp
public static void ConfigureForTesting(IFileSystem mockFileSystem)
```

This method sets:
```csharp
ThreadLocalFileSystemFactory.Value = () => mockFileSystem;
```

This means **all tests share the same MockFileSystem instance**, which can lead to test interference when tests run in parallel.

## The Solution Available

The AppData class actually provides a **better, thread-safe approach** that the tests are NOT currently using:

```csharp
public static void ConfigureForTesting(Func<IFileSystem> fileSystemFactory)
```

This factory-based approach ensures each access gets a fresh MockFileSystem instance, making tests thread-safe.

## Recommendation

To make the tests truly thread-safe with isolated filesystem instances, the test setup should be changed from:

```csharp
AppData.ConfigureForTesting(new MockFileSystem());
```

To:

```csharp
AppData.ConfigureForTesting(() => new MockFileSystem());
```

This way, each test method (or each access to the filesystem) would get its own isolated MockFileSystem instance, preventing test interference during parallel execution.

The codebase documentation even mentions this in the derived cursor rules, emphasizing the importance of using the factory pattern for concurrent/parallel tests.

---

_**User**_

please remove the non-threadsafe apis and correct the tests

---

_**Assistant**_



---

I'll remove the non-threadsafe API and update the tests to use the threadsafe factory-based approach. Let me start by examining the current AppData implementation and then make the necessary changes.

---

Read file: AppDataStorage/AppData.cs

---

Now let me read the non-threadsafe method to see exactly what needs to be removed:

---

Read file: AppDataStorage/AppData.cs

---

Now I'll remove the non-threadsafe API and update the tests. First, let me remove the non-threadsafe `ConfigureForTesting` method:

---



---

Now let me update the documentation to reflect that this is the only method:

---



---

Now I need to update the tests to use the factory-based approach. Let me start with the main test file:

---



---

I see there's still a test using the old API. Let me search for all instances of the old API usage:

---

<details>
            <summary>Grep search for "ConfigureForTesting\(new MockFileSystem\(\)\)" ‚Ä¢ **4** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L27 | `AppData.ConfigureForTesting(new MockFileSystem());` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/.specstory/history/2025-06-08_12-12-testing-threadsafe-mock-filesystem-usage.md` | L104 | `AppData.ConfigureForTesting(new MockFileSystem());` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/.specstory/history/2025-06-08_12-12-testing-threadsafe-mock-filesystem-usage.md` | L109 | `The tests are using `AppData.ConfigureForTesting(new MockFileSystem())` which creates a **single shared MockFileSystem instance** for all tests in that test class. This approach has a significant limitation.` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/.specstory/history/2025-06-08_12-12-testing-threadsafe-mock-filesystem-usage.md` | L141 | `AppData.ConfigureForTesting(new MockFileSystem());` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/.specstory/history/2025-05-21_09-51-expose-mock-filesystem-for-testing.md` | L1358 | `1. Replace `AppData.FileSystem = new MockFileSystem()` with `AppData.ConfigureForTesting(new MockFileSystem())` in the Setup methods` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/.specstory/history/2025-05-21_09-51-expose-mock-filesystem-for-testing.md` | L1675 | `AppData.ConfigureForTesting(new MockFileSystem()); // Thread-local now!` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/.cursor/rules/derived-cursor-rules.mdc` | L42 | `‚ü™ 329 characters skipped ‚ü´MockFileSystem());` instead of `AppData.ConfigureForTesting(new MockFileSystem());` to ensure each test gets its own isolated `MockFileSystem` instance.**` |

</details>

---

I also need to check for any test that checks the old API specifically:

---

<details>
            <summary>Grep search for "TestConfigureForTesting" ‚Ä¢ **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L317 | `public void TestConfigureForTesting()` |

</details>

---

Let me check the content of that test:

---

Read file: AppDataStorage.Test/AppDataTests.cs

---

Now I need to update the TestConfigureForTesting method and update the other test file. Let me fix the TestConfigureForTesting method first:

---



---

Let me fix the linter error by using the generic version:

---



---

Now let me update the StrongStringTests.cs file:

---



---

Now let me run the tests to make sure everything is working correctly:

---

```bash
dotnet test
```

```
C:\dev\ktsu-dev\AppDataStorage>dotnet test
Microsoft Windows [Version 10.0.26100.4061]
(c) Microsoft Corporation. All rights reserved.

C:\dev\ktsu-dev\AppDataStorage>dotnet test


























Restore complete (4.3s)
  AppDataStorage succeeded (0.6s) ‚Üí AppDataStorage\bin\Debug\net9.0\ktsu.AppDataStorage.dll
  AppDataStorage.Test succeeded (0.9s) ‚Üí AppDataStorage.Test\bin\Debug\net9.0\ktsu.AppDataStorage.Test.dll
  AppDataStorage.Test test failed with 37 error(s) (7.2s)
    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestSaveCreatesFile (80ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveCreatesFile threw exception:      
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveCreatesFile() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\
      AppDataTests.cs:line 36
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestSaveCleansBackupFile (3ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveCleansBackupFile threw excepti
      on:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveCleansBackupFile() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.
      Test\AppDataTests.cs:line 47
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(66): error test failed:
      TestEnsureDirectoryExistsForFilePath (5ms): Assert.IsTrue failed. Directory was not created.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsForFilePath() in C:\dev\ktsu-dev\AppDataStorage\App
      DataStorage.Test\AppDataTests.cs:line 66
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(77): error test failed:
      TestEnsureDirectoryExistsForDirectoryPath (1ms): Assert.IsTrue failed. Directory was not created.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsForDirectoryPath() in C:\dev\ktsu-dev\AppDataStorag
      e\AppDataStorage.Test\AppDataTests.cs:line 77
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestWriteTextCreatesFile (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestWriteTextCreatesFile threw excepti
      on:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.Test.AppDataTests.TestWriteTextCreatesFile() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.
      Test\AppDataTests.cs:line 101
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestWriteTextCreatesBackupFileOnOverwrite (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestWriteTextCreatesB
      ackupFileOnOverwrite threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.Test.AppDataTests.TestWriteTextCreatesBackupFileOnOverwrite() in C:\dev\ktsu-dev\AppDataStorag
      e\AppDataStorage.Test\AppDataTests.cs:line 112
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestReadTextReturnsCorrectData (4ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestReadTextReturnsCorrectData t
      hrew exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.Test.AppDataTests.TestReadTextReturnsCorrectData() in C:\dev\ktsu-dev\AppDataStorage\AppDataSt
      orage.Test\AppDataTests.cs:line 125
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestReadTextRestoresFromBackupIfMainFileMissing (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestReadTextRes
      toresFromBackupIfMainFileMissing threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.Test.AppDataTests.TestReadTextRestoresFromBackupIfMainFileMissing() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 136
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestQueueSaveSetsSaveQueuedTime (5ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestQueueSaveSetsSaveQueuedTime
       threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestQueueSaveSetsSaveQueuedTime() in C:\dev\ktsu-dev\AppDataStorage\AppDataS
      torage.Test\AppDataTests.cs:line 156
         at ktsu.AppDataStorage.Test.AppDataTests.TestQueueSaveSetsSaveQueuedTime() in C:\dev\ktsu-dev\AppDataStorage\AppDataS
      torage.Test\AppDataTests.cs:line 149
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestSaveIfRequiredSavesDataAfterDebounceTime (3s 111ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfReq
      uiredSavesDataAfterDebounceTime threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredSavesDataAfterDebounceTime() in C:\dev\ktsu-dev\AppDataSto
      rage\AppDataStorage.Test\AppDataTests.cs:line 174
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestSaveIfRequiredDoesNotSaveBeforeDebounceTime (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequi
      redDoesNotSaveBeforeDebounceTime threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredDoesNotSaveBeforeDebounceTime() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 187
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredDoesNotSaveBeforeDebounceTime() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 178
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestDisposeSavesDataIfSaveQueued (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestDisposeSavesDataIfSaveQueu
      ed threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestDisposeSavesDataIfSaveQueued() in C:\dev\ktsu-dev\AppDataStorage\AppData
      Storage.Test\AppDataTests.cs:line 196
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestIsSaveQueuedReturnsCorrectValue (1ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestIsSaveQueuedReturnsCorr
      ectValue threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestIsSaveQueuedReturnsCorrectValue() in C:\dev\ktsu-dev\AppDataStorage\AppD
      ataStorage.Test\AppDataTests.cs:line 233
         at ktsu.AppDataStorage.Test.AppDataTests.TestIsSaveQueuedReturnsCorrectValue() in C:\dev\ktsu-dev\AppDataStorage\AppD
      ataStorage.Test\AppDataTests.cs:line 226
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestIsDebounceTimeElapsedReturnsCorrectValue (3s 111ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestIsDebounc
      eTimeElapsedReturnsCorrectValue threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestIsDebounceTimeElapsedReturnsCorrectValue() in C:\dev\ktsu-dev\AppDataSto
      rage\AppDataStorage.Test\AppDataTests.cs:line 246
         at ktsu.AppDataStorage.Test.AppDataTests.TestIsDebounceTimeElapsedReturnsCorrectValue() in C:\dev\ktsu-dev\AppDataSto
      rage\AppDataStorage.Test\AppDataTests.cs:line 237
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateHandlesCorruptFile (4ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateHandlesCorru
      ptFile threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
         at System.Lazy`1.ExecutionAndPublication(LazyHelper executionAndPublication, Boolean useDefaultConstructor)
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateHandlesCorruptFile() in C:\dev\ktsu-dev\AppDataStorage\AppDa
      taStorage.Test\AppDataTests.cs:line 251
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestMultipleSavesOnlyWriteOnceWithinDebouncePeriod (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestMultiple
      SavesOnlyWriteOnceWithinDebouncePeriod threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.Test.AppDataTests.TestMultipleSavesOnlyWriteOnceWithinDebouncePeriod() in C:\dev\ktsu-dev\AppD
      ataStorage\AppDataStorage.Test\AppDataTests.cs:line 266
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateWithNullSubdirectoryAndFileName (3ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreat
      eWithNullSubdirectoryAndFileName threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWithNullSubdirectoryAndFileName() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 310
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestDisposeCanBeCalledMultipleTimes (1ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestDisposeCanBeCalledMulti
      pleTimes threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.Dispose(Boolean disposing) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 386
         at ktsu.AppDataStorage.AppData`1.Dispose() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 400      
         at ktsu.AppDataStorage.Test.AppDataTests.TestDisposeCanBeCalledMultipleTimes() in C:\dev\ktsu-dev\AppDataStorage\AppD
      ataStorage.Test\AppDataTests.cs:line 352
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestGetReturnsSameInstance (0ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestGetReturnsSameInstance threw exc
      eption:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
      --- End of stack trace from previous location ---
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.Test.AppDataTests.TestGetReturnsSameInstance() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorag
      e.Test\AppDataTests.cs:line 361
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateDoesNotOverwriteExistingData (0ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateDo
      esNotOverwriteExistingData threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
      --- End of stack trace from previous location ---
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateDoesNotOverwriteExistingData() in C:\dev\ktsu-dev\AppDataSto
      rage\AppDataStorage.Test\AppDataTests.cs:line 370
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(419): error test failed:
      TestEnsureDirectoryExistsWithValidFilePath (2ms): Assert.IsTrue failed. Directory was not created.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsWithValidFilePath() in C:\dev\ktsu-dev\AppDataStora
      ge\AppDataStorage.Test\AppDataTests.cs:line 419
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(430): error test failed:
      TestEnsureDirectoryExistsWithValidDirectoryPath (2ms): Assert.IsTrue failed. Directory was not created.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsWithValidDirectoryPath() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 430
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(441): error test failed:
      TestEnsureDirectoryExistsWithNestedDirectories (1ms): Assert.IsTrue failed. Nested directory structure was not created. 
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsWithNestedDirectories() in C:\dev\ktsu-dev\AppDataS
      torage\AppDataStorage.Test\AppDataTests.cs:line 441
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestSaveCreatesBackupIfInitialSaveFails (1ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveCreatesBackupIf
      InitialSaveFails threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveCreatesBackupIfInitialSaveFails() in C:\dev\ktsu-dev\AppDataStorage\
      AppDataStorage.Test\AppDataTests.cs:line 449
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateRecoversFromCorruptBackup (0ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateRecov
      ersFromCorruptBackup threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
      --- End of stack trace from previous location ---
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateRecoversFromCorruptBackup() in C:\dev\ktsu-dev\AppDataStorag
      e\AppDataStorage.Test\AppDataTests.cs:line 463
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateCreatesDirectoryIfNotExists (3ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateCre
      atesDirectoryIfNotExists threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateCreatesDirectoryIfNotExists() in C:\dev\ktsu-dev\AppDataStor
      age\AppDataStorage.Test\AppDataTests.cs:line 480
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(495): error test failed:
      TestEnsureDirectoryExistsHandlesRelativePaths (1ms): Assert.IsTrue failed. Directory should be created.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsHandlesRelativePaths() in C:\dev\ktsu-dev\AppDataSt
      orage\AppDataStorage.Test\AppDataTests.cs:line 495
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateWithSubdirectory (6ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWithSubdirecto
      ry threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\subdir\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory) in C:\dev\ktsu-dev\AppDataStorage\A
      ppDataStorage\AppData.cs:line 456
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWithSubdirectory() in C:\dev\ktsu-dev\AppDataStorage\AppData
      Storage.Test\AppDataTests.cs:line 502
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateWithFileName (3ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWithFileName threw
       exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\custom_file.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(FileName fileName) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\App
      Data.cs:line 463
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWithFileName() in C:\dev\ktsu-dev\AppDataStorage\AppDataStor
      age.Test\AppDataTests.cs:line 512
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateWithSubdirectoryAndFileName (3ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWit
      hSubdirectoryAndFileName threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\subdir\custom_file.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateWithSubdirectoryAndFileName() in C:\dev\ktsu-dev\AppDataStor
      age\AppDataStorage.Test\AppDataTests.cs:line 523
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateCreatesNewInstanceIfFileDoesNotExist (3ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOr
      CreateCreatesNewInstanceIfFileDoesNotExist threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateCreatesNewInstanceIfFileDoesNotExist() in C:\dev\ktsu-dev\Ap
      pDataStorage\AppDataStorage.Test\AppDataTests.cs:line 533
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestLoadOrCreateLoadsExistingData (0ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateLoadsExisting
      Data threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
      --- End of stack trace from previous location ---
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateLoadsExistingData() in C:\dev\ktsu-dev\AppDataStorage\AppDat
      aStorage.Test\AppDataTests.cs:line 542
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestQueueSaveStaticMethod (0ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestQueueSaveStaticMethod threw excep
      tion:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
      --- End of stack trace from previous location ---
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.AppData`1.QueueSave() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 468    
         at ktsu.AppDataStorage.Test.AppDataTests.TestQueueSaveStaticMethod() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage
      .Test\AppDataTests.cs:line 555
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(130): error test failed:
      TestSaveIfRequiredStaticMethod (0ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredStaticMethod t
      hrew exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\test_app_data.json.tmp'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 130
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 353
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 424
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 449 
         at System.Lazy`1.ViaFactory(LazyThreadSafetyMode mode)
      --- End of stack trace from previous location ---
         at System.Lazy`1.CreateValue()
         at ktsu.AppDataStorage.AppData`1.Get() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 291
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredStaticMethod() in C:\dev\ktsu-dev\AppDataStorage\AppDataSt
      orage.Test\AppDataTests.cs:line 564
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\StrongStringTests.cs(44): error test failed:
      TestStrongStrings (3ms): Test method ktsu.AppDataStorage.Test.StrongStringTests.TestStrongStrings threw exception:      
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\storage.json'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.Delete(String path)
         at ktsu.AppDataStorage.Test.StrongStringTests.TestStrongStrings() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Te
      st\StrongStringTests.cs:line 44
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\StrongStringTests.cs(93): error test failed:
      TestSaveAndLoad (1ms): Test method ktsu.AppDataStorage.Test.StrongStringTests.TestSaveAndLoad threw exception:
      System.IO.DirectoryNotFoundException: Could not find a part of the path 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.
      AppDataStorage.Test\storage.json'.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFile.VerifyDirectoryExists(String path)
         at System.IO.Abstractions.TestingHelpers.MockFile.Delete(String path)
         at ktsu.AppDataStorage.Test.StrongStringTests.TestSaveAndLoad() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test
      \StrongStringTests.cs:line 93
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\bin\Debug\net9.0\ktsu.AppDataStorage.Test.dll : error run failed: Tests
 failed: 'C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\bin\Debug\net9.0\TestResults\ktsu.AppDataStorage.Test_net9.0_x64.
log' [net9.0|x64]

Test summary: total: 54, failed: 36, succeeded: 18, skipped: 0, duration: 6.9s
Build failed with 37 error(s) in 13.2s

C:\dev\ktsu-dev\AppDataStorage>
```

---

_**User**_

im still suspicious of this line, every call to the filesystem will be through a different instance, rather that each test having its own instance,

---

_**Assistant**_



---

You're absolutely right! That's a critical issue. The current implementation creates a **new** MockFileSystem instance on every single filesystem access, rather than each test having its own persistent instance.

Looking at this line:
```csharp
internal static IFileSystem FileSystem => ThreadLocalFileSystemFactory.Value?.Invoke() ?? DefaultFileSystem;
```

This means:
- `AppData.FileSystem.File.WriteAllText(...)` ‚Üí Creates MockFileSystem instance A
- `AppData.FileSystem.File.ReadAllText(...)` ‚Üí Creates MockFileSystem instance B

The file written to instance A won't exist in instance B! Each test should get its own instance, but that instance should persist throughout the test.

Let me fix this by storing the actual IFileSystem instance in ThreadLocal, not the factory:

---



---

Now I also need to update the `ResetFileSystem` method to clear both the factory and the cached instance:

---



---

Now let's test this fix:

---

```bash
dotnet test --verbosity normal
```

```
C:\dev\ktsu-dev\AppDataStorage>dotnet test --verbosity normal
Microsoft Windows [Version 10.0.26100.4061]
(c) Microsoft Corporation. All rights reserved.

C:\dev\ktsu-dev\AppDataStorage>dotnet test --verbosity normal


























Restore complete (0.7s)
  AppDataStorage succeeded (0.6s) ‚Üí AppDataStorage\bin\Debug\net9.0\ktsu.AppDataStorage.dll
  AppDataStorage.Test succeeded (0.9s) ‚Üí AppDataStorage.Test\bin\Debug\net9.0\ktsu.AppDataStorage.Test.dll
  AppDataStorage.Test test failed with 11 error(s) (13.5s)
    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(62): error test failed:
      TestEnsureDirectoryExistsForFilePath (16ms): Assert.IsFalse failed. Directory should not exist initially.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsForFilePath() in C:\dev\ktsu-dev\AppDataStorage\App
      DataStorage.Test\AppDataTests.cs:line 62
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(186): error test failed:
      TestSaveIfRequiredDoesNotSaveBeforeDebounceTime (5ms): Assert.IsFalse failed. File should not be saved due to debounce. 
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredDoesNotSaveBeforeDebounceTime() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 186
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(211): error test failed:
      TestDisposeDoesNotSaveIfNoSaveQueued (0ms): Assert.IsFalse failed. File should not be saved if no save was queued.      
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestDisposeDoesNotSaveIfNoSaveQueued() in C:\dev\ktsu-dev\AppDataStorage\App
      DataStorage.Test\AppDataTests.cs:line 211
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(415): error test failed:
      TestEnsureDirectoryExistsWithValidFilePath (0ms): Assert.IsFalse failed. Directory should not exist initially.
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsWithValidFilePath() in C:\dev\ktsu-dev\AppDataStora
      ge\AppDataStorage.Test\AppDataTests.cs:line 415
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(426): error test failed:
      TestEnsureDirectoryExistsWithValidDirectoryPath (1ms): Assert.IsFalse failed. Directory should not exist initially.     
      Stack Trace:
         at ktsu.AppDataStorage.Test.AppDataTests.TestEnsureDirectoryExistsWithValidDirectoryPath() in C:\dev\ktsu-dev\AppData
      Storage\AppDataStorage.Test\AppDataTests.cs:line 426
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\AppDataTests.cs(469): error test failed:
      TestLoadOrCreateRecoversFromCorruptBackup (1ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateRecov
      ersFromCorruptBackup threw exception:
      System.IO.IOException: The process cannot access the file 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.AppDataStorage
      .Test\test_app_data.json' because it is being used by another process.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFileData.CheckFileAccess(String path, FileAccess access)
         at System.IO.Abstractions.TestingHelpers.MockFileSystem.AddFile(String path, MockFileData mockFile, Boolean verifyAcc
      ess)
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents, Encoding encoding)      
         at System.IO.Abstractions.TestingHelpers.MockFile.WriteAllText(String path, String contents)
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateRecoversFromCorruptBackup() in C:\dev\ktsu-dev\AppDataStorag
      e\AppDataStorage.Test\AppDataTests.cs:line 469
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(188): error test failed:
      TestLoadOrCreateCreatesDirectoryIfNotExists (1ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateCre
      atesDirectoryIfNotExists threw exception:
      System.IO.IOException: The process cannot access the file 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.AppDataStorage
      .Test\test_app_data.json' because it is being used by another process.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFileData.CheckFileAccess(String path, FileAccess access)
         at System.IO.Abstractions.TestingHelpers.MockFile.ReadAllTextInternal(String path, Encoding encoding)
         at System.IO.Abstractions.TestingHelpers.MockFile.ReadAllText(String path, Encoding encoding)
         at System.IO.Abstractions.TestingHelpers.MockFile.ReadAllText(String path)
         at ktsu.AppDataStorage.AppData.ReadText[T](T appData) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:lin
      e 188
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 449
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 478 
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateCreatesDirectoryIfNotExists() in C:\dev\ktsu-dev\AppDataStor
      age\AppDataStorage.Test\AppDataTests.cs:line 480
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(188): error test failed:
      TestLoadOrCreateCreatesNewInstanceIfFileDoesNotExist (1ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOr
      CreateCreatesNewInstanceIfFileDoesNotExist threw exception:
      System.IO.IOException: The process cannot access the file 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.AppDataStorage
      .Test\test_app_data.json' because it is being used by another process.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFileData.CheckFileAccess(String path, FileAccess access)
         at System.IO.Abstractions.TestingHelpers.MockFile.ReadAllTextInternal(String path, Encoding encoding)
         at System.IO.Abstractions.TestingHelpers.MockFile.ReadAllText(String path, Encoding encoding)
         at System.IO.Abstractions.TestingHelpers.MockFile.ReadAllText(String path)
         at ktsu.AppDataStorage.AppData.ReadText[T](T appData) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:lin
      e 188
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate(RelativeDirectoryPath subdirectory, FileName fileName) in C:\dev\ktsu-d
      ev\AppDataStorage\AppDataStorage\AppData.cs:line 449
         at ktsu.AppDataStorage.AppData`1.LoadOrCreate() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 478 
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateCreatesNewInstanceIfFileDoesNotExist() in C:\dev\ktsu-dev\Ap
      pDataStorage\AppDataStorage.Test\AppDataTests.cs:line 533
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(159): error test failed:
      TestLoadOrCreateLoadsExistingData (2ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateLoadsExisting
      Data threw exception:
      System.IO.IOException: The process cannot access the file 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.AppDataStorage
      .Test\test_app_data.json' because it is being used by another process.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFileData.CheckFileAccess(String path, FileAccess access)
         at System.IO.Abstractions.TestingHelpers.MockFile.Copy(String sourceFileName, String destFileName, Boolean overwrite)
         at System.IO.Abstractions.TestingHelpers.MockFile.Copy(String sourceFileName, String destFileName)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 159
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 382
         at ktsu.AppDataStorage.Test.AppDataTests.TestLoadOrCreateLoadsExistingData() in C:\dev\ktsu-dev\AppDataStorage\AppDat
      aStorage.Test\AppDataTests.cs:line 544
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs(159): error test failed:
      TestSaveIfRequiredStaticMethod (3s 110ms): Test method ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredStaticMet
      hod threw exception:
      System.IO.IOException: The process cannot access the file 'C:\Users\MatthewEdmondson\AppData\Roaming\ktsu.AppDataStorage
      .Test\test_app_data.json' because it is being used by another process.
      Stack Trace:
         at System.IO.Abstractions.TestingHelpers.MockFileData.CheckFileAccess(String path, FileAccess access)
         at System.IO.Abstractions.TestingHelpers.MockFile.Copy(String sourceFileName, String destFileName, Boolean overwrite)
         at System.IO.Abstractions.TestingHelpers.MockFile.Copy(String sourceFileName, String destFileName)
         at ktsu.AppDataStorage.AppData.WriteText[T](T appData, String text) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\
      AppData.cs:line 159
         at ktsu.AppDataStorage.AppData`1.Save() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 382
         at ktsu.AppDataStorage.AppData.SaveIfRequired[T](T appData) in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.
      cs:line 236
         at ktsu.AppDataStorage.AppData`1.SaveIfRequired() in C:\dev\ktsu-dev\AppDataStorage\AppDataStorage\AppData.cs:line 50
      2
         at ktsu.AppDataStorage.Test.AppDataTests.TestSaveIfRequiredStaticMethod() in C:\dev\ktsu-dev\AppDataStorage\AppDataSt
      orage.Test\AppDataTests.cs:line 569
         at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)    
         at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)


    C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\bin\Debug\net9.0\ktsu.AppDataStorage.Test.dll : error run failed: Tests
 failed: 'C:\dev\ktsu-dev\AppDataStorage\AppDataStorage.Test\bin\Debug\net9.0\TestResults\ktsu.AppDataStorage.Test_net9.0_x64.
log' [net9.0|x64]

Test summary: total: 54, failed: 10, succeeded: 44, skipped: 0, duration: 13.2s
Build failed with 11 error(s) in 16.0s

C:\dev\ktsu-dev\AppDataStorage>
```

---

_**User**_

I want every test to configure a new mock filesystem instance

---

_**Assistant**_



---

You're right! The current setup with `[TestInitialize]` means all tests in a class share the same mock filesystem instance, causing test interference. Let me fix this by configuring a fresh mock filesystem in each individual test method.

---



---

I need to add the setup and cleanup calls to each test method. Let me start by updating a few test methods to show the pattern:

---



---

Rather than manually updating each test method individually, let me create a more automated approach. Let me read all the test methods first to understand the full scope:

---

<details>
            <summary>Grep search for "\[TestMethod\]" ‚Ä¢ **4** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L31 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L38 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L60 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L68 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L76 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L87 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L34 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L53 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L68 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L80 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L91 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L99 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L107 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L118 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L131 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L142 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L158 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L169 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L187 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L200 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L213 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L225 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L235 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L246 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L259 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L272 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L295 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L304 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L311 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L318 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L328 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L336 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L345 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L358 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L369 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L378 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L389 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L397 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L405 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L413 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L421 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L433 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L444 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L455 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L471 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L488 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L497 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L509 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L519 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L529 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L541 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L550 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L561 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L572 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L34 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L53 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L68 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L80 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L91 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L99 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L107 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L118 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L131 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L142 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L158 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L169 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L187 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L200 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L213 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L225 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L235 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L246 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L259 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L272 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L295 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L304 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L311 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L318 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L328 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L336 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L345 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L358 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L369 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L378 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L389 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L397 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L405 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L413 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L421 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L433 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L444 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L455 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L471 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L488 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L497 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L509 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L519 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L529 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L541 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L550 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L561 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/AppDataTests.cs` | L572 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L31 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L38 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L60 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L68 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L76 | `[TestMethod]` |
| `file:///c%3A/dev/ktsu-dev/AppDataStorage/AppDataStorage.Test/StrongStringTests.cs` | L87 | `[TestMethod]` |

</details>

---

That's a lot of test methods to update individually. Let me take a different approach by creating a base test class with setup/cleanup or using a more efficient pattern. Instead, let me revert to using `[TestInitialize]` and `[TestCleanup]` attributes which is the standard MSTest approach:

---



---

Now let me revert the test method I modified back to its original form:

---



---

Now let me do the same for the StrongStringTests.cs:

---



---

Now let's test this approach:

---

```bash
dotnet test
```

```
C:\dev\ktsu-dev\AppDataStorage>dotnet test
Restore complete (0.5s)
  AppDataStorage succeeded (0.3s) ‚Üí AppDataStorage\bin\Debug\net9.0\ktsu.AppData
Storage.dll
  AppDataStorage.Test succeeded (0.4s) ‚Üí AppDataStorage.Test\bin\Debug\net9.0\kt
su.AppDataStorage.Test.dll
```

---

Great! The tests are passing now. Let me run them again with more verbose output to make sure everything is working correctly:

---

```bash
dotnet test --verbosity normal
```

```
  AppDataStorage.Test test succeeded (13.3s)

Test summary: total: 54, failed: 0, succeeded: 54, skipped: 0, duration: 12.9s  
Build succeeded in 14.6s

C:\dev\ktsu-dev\AppDataStorage>q^D^C
'q' is not recognized as an internal or external command,
operable program or batch file.

C:\dev\ktsu-dev\AppDataStorage>dotnet test --verbosity normal
Restore complete (0.5s)
  AppDataStorage succeeded (0.1s) ‚Üí AppDataStorage\bin\Debug\net9.0\ktsu.AppData
Storage.dll
  AppDataStorage.Test succeeded (0.1s) ‚Üí AppDataStorage.Test\bin\Debug\net9.0\kt
su.AppDataStorage.Test.dll
  AppDataStorage.Test test succeeded (13.3s)

Test summary: total: 54, failed: 0, succeeded: 54, skipped: 0, duration: 13.0s
Build succeeded in 14.3s

C:\dev\ktsu-dev\AppDataStorage>
```

---

Perfect! All 54 tests are now passing. Let me summarize what I've accomplished:

## Summary of Changes

1. **Removed the non-threadsafe API**: Deleted the `ConfigureForTesting(IFileSystem mockFileSystem)` overload that shared instances between tests.

2. **Fixed the filesystem instance management**: Changed from creating a new instance on every access to creating one instance per test thread and caching it:
   ```csharp
   // Before: New instance on every call
   internal static IFileSystem FileSystem => ThreadLocalFileSystemFactory.Value?.Invoke() ?? DefaultFileSystem;
   
   // After: One persistent instance per test thread
   internal static IFileSystem FileSystem
   {
       get
       {
           if (ThreadLocalFileSystem.Value is not null)
               return ThreadLocalFileSystem.Value;
           
           if (ThreadLocalFileSystemFactory.Value is not null)
           {
               ThreadLocalFileSystem.Value = ThreadLocalFileSystemFactory.Value();
               return ThreadLocalFileSystem.Value;
           }
           
           return DefaultFileSystem;
       }
   }
   ```

3. **Added proper test isolation**: Each test now gets:
   - `[TestInitialize]`: Configures a fresh MockFileSystem factory for this test thread
   - `[TestCleanup]`: Resets the filesystem to clear the thread-local cache

4. **Updated all tests**: Both test classes now use the factory-based approach:
   ```csharp
   AppData.ConfigureForTesting(() => new MockFileSystem());
   ```

## Result

Now every test gets its own isolated MockFileSystem instance that persists throughout the test execution, ensuring:
- ‚úÖ Thread safety for parallel test execution
- ‚úÖ Test isolation - each test starts with a clean filesystem 
- ‚úÖ Consistency - the same filesystem instance is used throughout a single test
- ‚úÖ No test interference - changes in one test don't affect others

All 54 tests are passing successfully!

---

_**User**_

we dont need to configure a new factory for every test, but we do need to re-invoke the factory for each test so that it gets a new instance for that thread without interfering with anyother threads

---

_**Assistant**_



---

You're absolutely right! We only need to configure the factory once, but clear the cached instance for each test so the factory gets re-invoked. Let me fix this:

---



---



---

